<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Reports – Customers • Services • Classes</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            'soft': '0 10px 30px rgba(2, 6, 23, .06)'
          },
          colors: {
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              600: '#4f46e5',
              700: '#4338ca',
              900: '#312e81'
            }
          }
        }
      }
    }
  </script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <style>
    .scroll-smooth::-webkit-scrollbar { height: 8px; width: 8px; }
    .scroll-smooth::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 999px; }
    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="h-screen grid grid-cols-12">
    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-3 xl:col-span-2 bg-white border-r border-slate-200 p-3 md:p-4 overflow-y-auto">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-8 h-8 rounded-xl bg-brand-600/10 grid place-items-center">
          <i data-lucide="sparkles" class="w-4 h-4 text-brand-700"></i>
        </div>
        <div class="font-semibold">AI Reports</div>
      </div>

      <!-- Search -->
      <div class="mb-4">
        <div class="flex items-center gap-2 rounded-xl ring-1 ring-slate-200 bg-slate-50 px-3 py-2">
          <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
          <input id="report-search" placeholder="Find a report…" class="w-full bg-transparent outline-none text-sm"/>
        </div>
      </div>

      <nav id="report-nav" class="space-y-4 text-sm">
        <!-- Customers -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Customers</div>
          <ul class="space-y-1">
            <li><button data-report="top_spenders" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top spending customers</button></li>
            <li><button data-report="all_customers" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">All customers</button></li>
            <li><button data-report="members" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Members only</button></li>
            <li><button data-report="non_members" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Non‑Members only</button></li>
            <li><button data-report="non_member_savings" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top Non‑Members – potential savings</button></li>
            <li><button data-report="repeat_behavior" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Repeat purchases by item/category</button></li>
          </ul>
        </div>
        <!-- Services -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Services</div>
          <ul class="space-y-1">
            <li><button data-report="svc_top_new" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top services for NEW customers</button></li>
            <li><button data-report="svc_first_service_customers" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Customers whose first item is a service</button></li>
            <li><button data-report="range_busiest_month" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Gun Range – Busiest month</button></li>
            <li><button data-report="range_busiest_dow" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Gun Range – Busiest day of week</button></li>
          </ul>
        </div>
        <!-- Classes -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Classes</div>
          <ul class="space-y-1">
            <li><button data-report="cls_popular" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Most popular classes</button></li>
            <li><button data-report="cls_new_customers" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Classes bringing NEW customers</button></li>
            <li><button data-report="cls_top_spenders" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top 100 class spenders</button></li>
          </ul>
        </div>
        <!-- Products -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Products</div>
          <ul class="space-y-1">
            <li><button data-report="prd_top_sold" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top products sold (with exclusions)</button></li>
            <li><button data-report="prd_turnover" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">High turnover products</button></li>
            <li><button data-report="prd_least" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Least purchased products</button></li>
            <li><button data-report="prd_slow_movers" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Slow movers – longest on shelf</button></li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-9 xl:col-span-7 p-4 md:p-6 overflow-y-auto">
      <!-- Header + Filters -->
      <div class="flex flex-wrap items-center gap-3">
        <div class="text-xl md:text-2xl font-semibold">Reports</div>
        <div class="ml-auto"></div>
        <select id="audience" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm">
          <option value="all" selected>All Customers</option>
          <option value="members">Members only</option>
          <option value="non_members">Non‑Members only</option>
        </select>
        <select id="limitN" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm">
          <option value="5">Top 5</option>
          <option value="10" selected>Top 10</option>
          <option value="20">Top 20</option>
          <option value="50">Top 50</option>
          <option value="100">Top 100</option>
        </select>
        <input id="dateStart" type="date" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm" />
        <input id="dateEnd" type="date" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm" />
        <button id="applyFilters" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Apply</button>
      </div>

      <!-- Active report title -->
      <div class="mt-5 mb-3 flex items-center gap-2">
        <i data-lucide="square-chart" class="w-5 h-5 text-slate-500"></i>
        <div id="active-report-title" class="text-slate-700">Select a report from the left…</div>
      </div>

      <!-- SQL + Results -->
      <section class="grid grid-cols-12 gap-4">
        <div class="col-span-12">
          <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-soft">
            <div class="p-3 border-b border-slate-100 flex items-center gap-2">
              <i data-lucide="database" class="w-4 h-4 text-slate-500"></i>
              <div class="text-sm font-medium">Generated SQL (ClickHouse)</div>
              <div class="ml-auto flex items-center gap-2">
                <button id="copySql" title="Copy SQL" class="p-2 rounded-lg hover:bg-slate-50"><i data-lucide="copy" class="w-4 h-4"></i></button>
                <button id="runSql" class="px-3 py-1.5 rounded-lg bg-brand-600 text-white text-xs">Run</button>
              </div>
            </div>
            <pre id="sqlBox" class="p-4 overflow-auto text-sm bg-slate-50 rounded-b-2xl code"><span class="text-slate-400">-- SQL for the selected report will appear here</span></pre>
          </div>
        </div>

        <div class="col-span-12">
          <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-soft">
            <div class="p-3 border-b border-slate-100 flex items-center gap-2">
              <i data-lucide="table" class="w-4 h-4 text-slate-500"></i>
              <div class="text-sm font-medium">Results</div>
              <div id="rowsCount" class="text-xs text-slate-500 ml-2"></div>
            </div>
            <div id="results" class="p-3 overflow-auto"></div>
          </div>
        </div>
      </section>

      <!-- Integration note -->
      <div class="mt-4 text-xs text-slate-500">
        Wire <span class="code">Run</span> to your backend (e.g., <span class="code">POST /api/query</span> with <span class="code">{ sql }</span>) that executes the query on ClickHouse and returns rows JSON. This prototype simulates results.
      </div>
    </main>

    <!-- AI Chat -->
    <aside class="col-span-12 xl:col-span-3 border-l border-slate-200 bg-white p-4 flex flex-col">
      <div class="flex items-center gap-2 mb-2">
        <i data-lucide="bot" class="w-5 h-5 text-brand-700"></i>
        <div class="font-semibold">AI Chat</div>
      </div>

      <div id="chat" class="flex-1 overflow-y-auto space-y-3 pr-1">
        <div class="flex items-start gap-2">
          <div class="w-7 h-7 rounded-full bg-brand-600/10 grid place-items-center shrink-0"><i data-lucide="sparkles" class="w-4 h-4 text-brand-700"></i></div>
          <div class="bg-slate-50 rounded-2xl p-3 text-sm shadow-inner">Ask for a report in plain English. I’ll generate ClickHouse SQL and run it.</div>
        </div>
      </div>

      <div class="mt-3">
        <div class="flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 bg-white px-3 py-2">
          <input id="chatInput" placeholder="e.g., top 20 non-members by spend last quarter" class="flex-1 outline-none text-sm"/>
          <button id="sendChat" class="px-3 py-1.5 rounded-xl bg-brand-600 text-white text-xs">Send</button>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Top 10 spenders (members)</button>
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Busiest day for range (last 12 months)</button>
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Top 5 services bringing new customers</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    lucide.createIcons();

    // --- Helpers ---------------------------------------------------------------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmt = (v) => typeof v === 'number' ? v.toLocaleString() : v;

    // Put today's date into range
    const today = new Date().toISOString().slice(0,10);
    const thirty = new Date(Date.now()-29*24*3600*1000).toISOString().slice(0,10);
    $('#dateStart').value = thirty; $('#dateEnd').value = today;

    // --- Report definitions -> NL prompt -> SQL template -----------------------
    const SQLS = {
      top_spenders: ({audience, start, end, N}) => `/* Top ${N} ${audience.replace('_','-')} customers by spend */
WITH fo AS (
  SELECT * FROM orders
  WHERE order_date BETWEEN toDate('${start}') AND toDate('${end}')
  ${audience==='members' ? 'AND is_member_snapshot = 1' : audience==='non_members' ? 'AND is_member_snapshot = 0' : ''}
)
SELECT customer_id, sum(total) AS total_spend, countDistinct(id) AS orders
FROM fo
GROUP BY customer_id
ORDER BY total_spend DESC
LIMIT ${N};`,
      all_customers: ({start, end}) => `/* All customers who purchased in range */
SELECT distinct customer_id
FROM orders
WHERE order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      members: ({start,end}) => `SELECT distinct customer_id FROM orders WHERE is_member_snapshot=1 AND order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      non_members: ({start,end}) => `SELECT distinct customer_id FROM orders WHERE is_member_snapshot=0 AND order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      non_member_savings: ({start,end,N}) => `/* Potential savings for top non-members (assumes :discount_pct and :membership_price) */
WITH ranked AS (
  SELECT customer_id, sum(total) AS spend
  FROM orders
  WHERE is_member_snapshot=0 AND order_date BETWEEN toDate('${start}') AND toDate('${end}')
  GROUP BY customer_id
  ORDER BY spend DESC
  LIMIT ${N}
), eligible AS (
  SELECT o.customer_id, sum(oi.line_total) AS eligible_total
  FROM orders o
  INNER JOIN order_items oi ON oi.order_id=o.id
  WHERE o.customer_id IN (SELECT customer_id FROM ranked)
    AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
    AND oi.item_type IN ('product','service','class')
  GROUP BY o.customer_id
)
SELECT customer_id,
       eligible_total,
       round(eligible_total * :discount_pct, 2) AS discount_value,
       :membership_price AS membership_cost,
       round(eligible_total * :discount_pct - :membership_price, 2) AS net_savings
FROM eligible
ORDER BY net_savings DESC;`,
      repeat_behavior: ({start,end,N}) => `/* Customers with >1 instance of same item/category in period */
SELECT customer_id, item_type, anyHeavy(item_name) AS sample_item, count() AS occurrences
FROM orders o
INNER JOIN order_items oi ON oi.order_id=o.id
WHERE o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY customer_id, item_type, item_name
HAVING occurrences > 1
ORDER BY occurrences DESC
LIMIT ${N};`,
      svc_top_new: ({start,end,N}) => `/* Top services that are first-ever purchase for customers */
WITH first_dt AS (
  SELECT customer_id, min(order_date) AS first_date FROM orders GROUP BY customer_id
)
SELECT oi.item_name AS service_name, count() AS new_customers
FROM first_dt ft
INNER JOIN orders o ON o.customer_id=ft.customer_id AND o.order_date=ft.first_date
INNER JOIN order_items oi ON oi.order_id=o.id
WHERE oi.item_type='service' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY service_name
ORDER BY new_customers DESC
LIMIT ${N};`,
      svc_first_service_customers: ({start,end}) => `/* Customers whose first purchase was a service */
WITH first_dt AS (
  SELECT customer_id, min(order_date) AS first_date FROM orders GROUP BY customer_id
)
SELECT distinct o.customer_id
FROM first_dt ft
INNER JOIN orders o ON o.customer_id=ft.customer_id AND o.order_date=ft.first_date
INNER JOIN order_items oi ON oi.order_id=o.id
WHERE oi.item_type='service' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      range_busiest_month: ({start,end,audience}) => `/* Range busiest month by distinct customers */
SELECT formatDateTime(order_date, '%Y-%m') AS yyyymm, countDistinct(customer_id) AS customers
FROM orders o INNER JOIN order_items oi ON oi.order_id=o.id
WHERE oi.item_type='service' AND oi.category='Range'
  AND order_date BETWEEN toDate('${start}') AND toDate('${end}')
  ${audience==='members' ? 'AND is_member_snapshot=1' : audience==='non_members' ? 'AND is_member_snapshot=0' : ''}
GROUP BY yyyymm
ORDER BY customers DESC
LIMIT 1;`,
      range_busiest_dow: ({audience}) => `/* Busiest day of week (avg last 12 months) */
SELECT formatDateTime(order_date, '%A') AS dow,
       countDistinct(customer_id) / countDistinct(toDate(order_date)) AS avg_customers
FROM orders o INNER JOIN order_items oi ON oi.order_id=o.id
WHERE oi.item_type='service' AND oi.category='Range'
  AND order_date >= addMonths(today(), -12)
  ${audience==='members' ? 'AND is_member_snapshot=1' : audience==='non_members' ? 'AND is_member_snapshot=0' : ''}
GROUP BY dow
ORDER BY avg_customers DESC;`,
      cls_popular: ({start,end,N}) => `/* Most popular classes */
SELECT oi.item_name AS class_name, sum(oi.qty) AS seats_sold, countDistinct(o.id) AS orders
FROM order_items oi INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='class' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY class_name
ORDER BY seats_sold DESC
LIMIT ${N};`,
      cls_new_customers: ({start,end,N}) => `/* Classes that bring NEW customers */
WITH first_dt AS (
  SELECT customer_id, min(order_date) AS first_date FROM orders GROUP BY customer_id
)
SELECT oi.item_name AS class_name, count() AS new_customers
FROM first_dt ft
INNER JOIN orders o ON o.customer_id=ft.customer_id AND o.order_date=ft.first_date
INNER JOIN order_items oi ON oi.order_id=o.id
WHERE oi.item_type='class' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY class_name
ORDER BY new_customers DESC
LIMIT ${N};`,
      cls_top_spenders: ({start,end}) => `/* Top 100 customers by class spend */
SELECT o.customer_id, sum(oi.line_total) AS class_spend, count() AS class_lines
FROM order_items oi INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='class' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY o.customer_id
ORDER BY class_spend DESC
LIMIT 100;`,
      prd_top_sold: ({start,end,N,audience}) => `/* Top products sold with sample exclusions (:exclude_skus, :exclude_categories) */
SELECT oi.item_name, sum(oi.qty) AS units, sum(oi.line_total) AS revenue
FROM order_items oi INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='product' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
  ${audience==='members' ? 'AND is_member_snapshot=1' : audience==='non_members' ? 'AND is_member_snapshot=0' : ''}
  AND (:exclude_skus IS NULL OR oi.sku NOT IN (:exclude_skus))
  AND (:exclude_categories IS NULL OR oi.category NOT IN (:exclude_categories))
GROUP BY oi.item_name
ORDER BY units DESC
LIMIT ${N};`,
      prd_turnover: ({start,end,N}) => `/* High turnover products (line count) */
SELECT oi.item_name, count() AS lines, sum(oi.qty) AS units
FROM order_items oi INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='product' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY oi.item_name
ORDER BY lines DESC
LIMIT ${N};`,
      prd_least: ({start,end,N}) => `/* Least purchased products by units */
SELECT oi.item_name, sum(oi.qty) AS units
FROM order_items oi INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='product' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY oi.item_name
ORDER BY units ASC
LIMIT ${N};`,
      prd_slow_movers: ({N}) => `/* Slow movers (inventory-based) */
SELECT sku, on_hand, dateDiff('day', last_sold_at, today()) AS days_since_last_sale
FROM inventory
ORDER BY days_since_last_sale DESC
LIMIT ${N};`
    };

    const TITLES = {
      top_spenders: 'Top spending customers',
      all_customers: 'All customers (within date range)',
      members: 'Members only',
      non_members: 'Non‑Members only',
      non_member_savings: 'Top Non‑Members – potential membership savings',
      repeat_behavior: 'Repeat purchases by item/category',
      svc_top_new: 'Top services for NEW customers',
      svc_first_service_customers: 'Customers whose first purchase was a service',
      range_busiest_month: 'Gun Range – busiest month',
      range_busiest_dow: 'Gun Range – busiest day of week (avg last 12 months)',
      cls_popular: 'Most popular classes',
      cls_new_customers: 'Classes bringing NEW customers',
      cls_top_spenders: 'Top 100 class spenders',
      prd_top_sold: 'Top products sold (with exclusions)',
      prd_turnover: 'High turnover products',
      prd_least: 'Least purchased products',
      prd_slow_movers: 'Slow movers – longest on shelf'
    };

    // --- Renderers -------------------------------------------------------------
    function renderSQL(key) {
      const audience = $('#audience').value;
      const N = +$('#limitN').value;
      const start = $('#dateStart').value;
      const end = $('#dateEnd').value;
      const fn = SQLS[key];
      const sql = fn ? fn({audience, N, start, end}) : '-- no template';
      $('#active-report-title').textContent = TITLES[key] || 'Report';
      $('#sqlBox').textContent = sql;
      window.lastSQL = sql;
      window.lastReportKey = key;
      simulateResults(key, N);
    }

    function simulateResults(key, N) {
      let rows = [];
      if (key==='top_spenders') {
        for (let i=1;i<=N;i++) rows.push({customer_id: 1000+i, total_spend: 50000 + i*1375, orders: 3 + i%5});
      } else if (key==='prd_top_sold') {
        for (let i=1;i<=N;i++) rows.push({item_name: 'Item '+i, units: Math.round(400/i), revenue: (100000/i).toFixed(0)});
      } else if (key==='range_busiest_dow') {
        rows = [{dow:'Saturday', avg_customers: 220.4},{dow:'Sunday', avg_customers: 205.1},{dow:'Friday', avg_customers: 183.2}];
      } else {
        for (let i=1;i<=Math.min(N,10);i++) rows.push({col_a: 'Row '+i, col_b: i*7, col_c: i%2?'A':'B'});
      }
      renderTable(rows);
    }

    function renderTable(rows) {
      const wrap = $('#results');
      wrap.innerHTML = '';
      if (!rows.length) { wrap.innerHTML = '<div class="text-sm text-slate-500">No rows.</div>'; $('#rowsCount').textContent = ''; return; }
      const cols = Object.keys(rows[0]);
      const table = document.createElement('table');
      table.className = 'min-w-full text-sm';
      table.innerHTML = `
        <thead class="text-left text-slate-500 border-b">
          <tr>${cols.map(c=>`<th class="py-2 pr-4">${c}</th>`).join('')}</tr>
        </thead>
        <tbody class="divide-y">
          ${rows.map(r=>`<tr>${cols.map(c=>`<td class="py-2 pr-4">${fmt(r[c])}</td>`).join('')}</tr>`).join('')}
        </tbody>`;
      wrap.appendChild(table);
      $('#rowsCount').textContent = rows.length + ' rows (demo)';
    }

    // Bind report clicks
    $$('.rep-btn').forEach(btn => btn.addEventListener('click', () => renderSQL(btn.dataset.report)));
    $('#applyFilters').addEventListener('click', () => { if (window.lastReportKey) renderSQL(window.lastReportKey); });
    $('#copySql').addEventListener('click', async () => {
      await navigator.clipboard.writeText($('#sqlBox').textContent);
      alert('SQL copied');
    });
    $('#runSql').addEventListener('click', async () => {
      // Replace with: fetch('/api/query', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sql: $('#sqlBox').textContent }) })
      alert('Would POST SQL to backend and render results. (Demo renders sample rows).');
    });

    // Search filter for sidebar
    $('#report-search').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      $$('.rep-btn').forEach(b => {
        const show = b.textContent.toLowerCase().includes(q);
        b.parentElement.style.display = show ? '' : 'none';
      });
    });

    // Chips in chat
    $$('.chip').forEach(c => c.addEventListener('click', () => { $('#chatInput').value = c.textContent; }));

    // Chat -> NL to report key
    function nlToReportKey(text) {
      const t = text.toLowerCase();
      if (t.includes('spender') || (t.includes('top') && t.includes('customer'))) return 'top_spenders';
      if (t.includes('busiest') && t.includes('day')) return 'range_busiest_dow';
      if (t.includes('busiest') && t.includes('month')) return 'range_busiest_month';
      if (t.includes('class') && t.includes('new')) return 'cls_new_customers';
      if (t.includes('class') && (t.includes('popular') || t.includes('sold'))) return 'cls_popular';
      if (t.includes('service') && t.includes('new')) return 'svc_top_new';
      if (t.includes('non') && t.includes('member') && t.includes('savings')) return 'non_member_savings';
      if (t.includes('product') && (t.includes('top') || t.includes('sold'))) return 'prd_top_sold';
      if (t.includes('turnover')) return 'prd_turnover';
      if (t.includes('least')) return 'prd_least';
      return 'top_spenders';
    }

    function pushChat(role, text) {
      const row = document.createElement('div');
      row.className = 'flex items-start gap-2';
      if (role==='user') {
        row.innerHTML = '<div class="w-7 h-7 rounded-full bg-slate-900/10 grid place-items-center shrink-0"><i data-lucide="user" class="w-4 h-4 text-slate-700"></i></div><div class="bg-white rounded-2xl p-3 text-sm ring-1 ring-slate-200">'+text+'</div>';
      } else {
        row.innerHTML = '<div class="w-7 h-7 rounded-full bg-brand-600/10 grid place-items-center shrink-0"><i data-lucide="bot" class="w-4 h-4 text-brand-700"></i></div><div class="bg-slate-50 rounded-2xl p-3 text-sm shadow-inner">'+text+'</div>';
      }
      $('#chat').appendChild(row);
      $('#chat').scrollTop = $('#chat').scrollHeight;
      lucide.createIcons();
    }

    $('#sendChat').addEventListener('click', () => {
      const text = $('#chatInput').value.trim();
      if (!text) return;
      pushChat('user', text);
      const key = nlToReportKey(text);
      const audience = $('#audience').value;
      const N = +$('#limitN').value;
      const start = $('#dateStart').value;
      const end = $('#dateEnd').value;
      const sql = SQLS[key]({audience, N, start, end});
      pushChat('assistant', '<div class=\"text-xs text-slate-500 mb-1\">Generated SQL</div><pre class=\"code text-[12px] bg-white rounded-xl p-3 ring-1 ring-slate-200 overflow-auto\">'+sql.replace(/</g,'&lt;')+'</pre>');
      $('#active-report-title').textContent = TITLES[key] || 'Report';
      $('#sqlBox').textContent = sql;
      window.lastSQL = sql; window.lastReportKey = key;
      simulateResults(key, N);
      $('#chatInput').value = '';
    });
  </script>
</body>
</html>
