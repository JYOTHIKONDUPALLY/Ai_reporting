<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Reports – Customers • Services • Classes</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            'soft': '0 10px 30px rgba(2, 6, 23, .06)'
          },
          colors: {
            brand: {
              50: '#eef2ff',
              100: '#e0e7ff',
              600: '#4f46e5',
              700: '#4338ca',
              900: '#312e81'
            }
          }
        }
      }
    }
  </script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <style>
    .scroll-smooth::-webkit-scrollbar { height: 8px; width: 8px; }
    .scroll-smooth::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 999px; }
    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="h-screen grid grid-cols-12">
    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-3 xl:col-span-2 bg-white border-r border-slate-200 p-3 md:p-4 overflow-y-auto">
      <div class="flex items-center gap-2 mb-4">
        <div class="w-8 h-8 rounded-xl bg-brand-600/10 grid place-items-center">
          <i data-lucide="sparkles" class="w-4 h-4 text-brand-700"></i>
        </div>
        <div class="font-semibold">AI Reports</div>
      </div>

      <!-- Search -->
      <div class="mb-4">
        <div class="flex items-center gap-2 rounded-xl ring-1 ring-slate-200 bg-slate-50 px-3 py-2">
          <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
          <input id="report-search" placeholder="Find a report…" class="w-full bg-transparent outline-none text-sm"/>
        </div>
      </div>

      <nav id="report-nav" class="space-y-4 text-sm">
        <!-- Predefined Reports -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Predefined Reports</div>
          <ul class="space-y-1">
            <li><a href="<?php echo e(route('reports.predefined', 'daily-sales')); ?>" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 block">Daily Sales</a></li>
            <li><a href="<?php echo e(route('reports.predefined', 'top-items')); ?>" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 block">Top Items</a></li>
            <li><a href="<?php echo e(route('reports.predefined', 'revenue-by-franchise')); ?>" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 block">Revenue by Franchise</a></li>
            <li><a href="<?php echo e(route('reports.predefined', 'payments-by-method')); ?>" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 block">Payments by Method</a></li>
            <li><a href="<?php echo e(route('reports.predefined', 'refunds')); ?>" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 block">Refunds</a></li>
          </ul>
        </div>
        <!-- Custom Reports -->
        <div>
          <div class="uppercase text-xs text-slate-500 mb-2">Custom Reports</div>
          <ul class="space-y-1">
            <li><button data-report="top_spenders" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Top spending customers</button></li>
            <li><button data-report="all_customers" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">All customers</button></li>
            <li><button data-report="members" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Members only</button></li>
            <li><button data-report="non_members" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Non‑Members only</button></li>
            <li><button data-report="revenue_analysis" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Revenue Analysis</button></li>
            <li><button data-report="product_performance" class="rep-btn w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100">Product Performance</button></li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="col-span-12 md:col-span-9 xl:col-span-7 p-4 md:p-6 overflow-y-auto">
      <!-- Header + Filters -->
      <div class="flex flex-wrap items-center gap-3">
        <div class="text-xl md:text-2xl font-semibold">Reports</div>
        <div class="ml-auto"></div>
        <select id="audience" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm">
          <option value="all" selected>All Customers</option>
          <option value="members">Members only</option>
          <option value="non_members">Non‑Members only</option>
        </select>
        <select id="limitN" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm">
          <option value="5">Top 5</option>
          <option value="10" selected>Top 10</option>
          <option value="20">Top 20</option>
          <option value="50">Top 50</option>
          <option value="100">Top 100</option>
        </select>
        <input id="dateStart" type="date" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm" />
        <input id="dateEnd" type="date" class="rounded-xl ring-1 ring-slate-200 bg-white px-3 py-2 text-sm" />
        <button id="applyFilters" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm">Apply</button>
      </div>

      <!-- Active report title -->
      <div class="mt-5 mb-3 flex items-center gap-2">
        <i data-lucide="square-chart" class="w-5 h-5 text-slate-500"></i>
        <div id="active-report-title" class="text-slate-700">Select a report from the left…</div>
      </div>

      <!-- SQL + Results -->
      <section class="grid grid-cols-12 gap-4">
        <div class="col-span-12">
          <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-soft">
            <div class="p-3 border-b border-slate-100 flex items-center gap-2">
              <i data-lucide="database" class="w-4 h-4 text-slate-500"></i>
              <div class="text-sm font-medium">Generated SQL (ClickHouse)</div>
              <div class="ml-auto flex items-center gap-2">
                <button id="copySql" title="Copy SQL" class="p-2 rounded-lg hover:bg-slate-50"><i data-lucide="copy" class="w-4 h-4"></i></button>
                <button id="runSql" class="px-3 py-1.5 rounded-lg bg-brand-600 text-white text-xs">Run</button>
              </div>
            </div>
            <pre id="sqlBox" class="p-4 overflow-auto text-sm bg-slate-50 rounded-b-2xl code"><span class="text-slate-400">-- SQL for the selected report will appear here</span></pre>
          </div>
        </div>

        <div class="col-span-12">
          <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-soft">
            <div class="p-3 border-b border-slate-100 flex items-center gap-2">
              <i data-lucide="table" class="w-4 h-4 text-slate-500"></i>
              <div class="text-sm font-medium">Results</div>
              <div id="rowsCount" class="text-xs text-slate-500 ml-2"></div>
            </div>
            <div id="results" class="p-3 overflow-auto">
              <?php if(isset($error)): ?>
                <div class="p-3 bg-red-100 text-red-700 rounded">
                  Error: <?php echo e($error); ?>

                </div>
              <?php elseif(!empty($results)): ?>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm">
                    <thead class="text-left text-slate-500 border-b">
                      <tr>
                        <?php $__currentLoopData = array_keys($results[0]); $__env->addLoop($__currentLoopData); foreach($__currentLoopData as $col): $__env->incrementLoopIndices(); $loop = $__env->getLastLoop(); ?>
                          <th class="py-2 pr-4"><?php echo e($col); ?></th>
                        <?php endforeach; $__env->popLoop(); $loop = $__env->getLastLoop(); ?>
                      </tr>
                    </thead>
                    <tbody class="divide-y">
                      <?php $__currentLoopData = $results; $__env->addLoop($__currentLoopData); foreach($__currentLoopData as $row): $__env->incrementLoopIndices(); $loop = $__env->getLastLoop(); ?>
                        <tr>
                          <?php $__currentLoopData = $row; $__env->addLoop($__currentLoopData); foreach($__currentLoopData as $val): $__env->incrementLoopIndices(); $loop = $__env->getLastLoop(); ?>
                            <td class="py-2 pr-4"><?php echo e($val); ?></td>
                          <?php endforeach; $__env->popLoop(); $loop = $__env->getLastLoop(); ?>
                        </tr>
                      <?php endforeach; $__env->popLoop(); $loop = $__env->getLastLoop(); ?>
                    </tbody>
                  </table>
                </div>
                
                <?php
                  $page = $page ?? 1;
                  $perPage = $perPage ?? 25;
                ?>
                
                <div class="mt-4 flex justify-between items-center">
                  
                  <form method="POST" action="<?php echo e(route('reports.run')); ?>">
                    <?php echo csrf_field(); ?>
                    <input type="hidden" name="sql" value="<?php echo e($sql); ?>">
                    <input type="hidden" name="page" value="<?php echo e(max(1, $page - 1)); ?>">
                    <input type="hidden" name="perPage" value="<?php echo e($perPage); ?>">
                    <button type="submit" class="px-3 py-1 bg-gray-300 rounded"
                        <?php echo e($page <= 1 ? 'disabled' : ''); ?>>
                        ← Previous
                    </button>
                  </form>

                  
                  <div class="flex items-center space-x-3">
                    <span>Page <?php echo e($page); ?></span>
                    <form method="POST" action="<?php echo e(route('reports.run')); ?>">
                      <?php echo csrf_field(); ?>
                      <input type="hidden" name="sql" value="<?php echo e($sql); ?>">
                      <input type="hidden" name="page" value="1">
                      <select name="perPage" onchange="this.form.submit()" class="border rounded px-2 py-1">
                        <option value="10" <?php echo e($perPage == 10 ? 'selected' : ''); ?>>10</option>
                        <option value="25" <?php echo e($perPage == 25 ? 'selected' : ''); ?>>25</option>
                        <option value="50" <?php echo e($perPage == 50 ? 'selected' : ''); ?>>50</option>
                        <option value="100" <?php echo e($perPage == 100 ? 'selected' : ''); ?>>100</option>
                      </select>
                    </form>
                  </div>

                  
                  <form method="POST" action="<?php echo e(route('reports.run')); ?>">
                    <?php echo csrf_field(); ?>
                    <input type="hidden" name="sql" value="<?php echo e($sql); ?>">
                    <input type="hidden" name="page" value="<?php echo e($page + 1); ?>">
                    <input type="hidden" name="perPage" value="<?php echo e($perPage); ?>">
                    <button type="submit" class="px-3 py-1 bg-gray-300 rounded">
                        Next →
                    </button>
                  </form>
                </div>

                <form method="POST" action="<?php echo e(route('reports.export')); ?>" class="mt-4">
                  <?php echo csrf_field(); ?>
                  <input type="hidden" name="sql" value="<?php echo e($sql ?? ''); ?>">
                  <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">
                      Export CSV
                  </button>
                </form>
              <?php else: ?>
                <div class="text-sm text-slate-500">No results to display.</div>
              <?php endif; ?>
            </div>
          </div>
        </div>
      </section>

      <!-- Integration note -->
      <div class="mt-4 text-xs text-slate-500">
        Wire <span class="code">Run</span> to your backend (e.g., <span class="code">POST /api/query</span> with <span class="code">{ sql }</span>) that executes the query on ClickHouse and returns rows JSON. This prototype simulates results.
      </div>
    </main>

    <!-- AI Chat -->
    <aside class="col-span-12 xl:col-span-3 border-l border-slate-200 bg-white p-4 flex flex-col">
      <div class="flex items-center gap-2 mb-2">
        <i data-lucide="bot" class="w-5 h-5 text-brand-700"></i>
        <div class="font-semibold">AI Chat</div>
      </div>

      <div id="chat" class="flex-1 overflow-y-auto space-y-3 pr-1">
        <div class="flex items-start gap-2">
          <div class="w-7 h-7 rounded-full bg-brand-600/10 grid place-items-center shrink-0"><i data-lucide="sparkles" class="w-4 h-4 text-brand-700"></i></div>
          <div class="bg-slate-50 rounded-2xl p-3 text-sm shadow-inner">Ask for a report in plain English. I'll generate ClickHouse SQL and run it.</div>
        </div>
      </div>

      <div class="mt-3">
        <form method="POST" action="<?php echo e(route('reports.askAi')); ?>" id="chatForm">
          <?php echo csrf_field(); ?>
          <div class="flex items-center gap-2 rounded-2xl ring-1 ring-slate-200 bg-white px-3 py-2">
            <input id="chatInput" name="question" placeholder="e.g., top 20 non-members by spend last quarter" class="flex-1 outline-none text-sm"/>
            <button type="submit" class="px-3 py-1.5 rounded-xl bg-brand-600 text-white text-xs">Send</button>
          </div>
        </form>
        <div class="mt-2 flex flex-wrap gap-2">
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Top 10 spenders (members)</button>
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Busiest day for range (last 12 months)</button>
          <button class="chip px-2.5 py-1.5 rounded-xl bg-slate-100 text-xs">Top 5 services bringing new customers</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    lucide.createIcons();

    // --- Helpers ---------------------------------------------------------------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmt = (v) => typeof v === 'number' ? v.toLocaleString() : v;

    // Put today's date into range
    const today = new Date().toISOString().slice(0,10);
    const thirty = new Date(Date.now()-29*24*3600*1000).toISOString().slice(0,10);
    $('#dateStart').value = thirty; $('#dateEnd').value = today;

    // --- Report definitions -> SQL template -----------------------
    const SQLS = {
      top_spenders: ({audience, start, end, N}) => `/* Top ${N} ${audience.replace('_','-')} customers by spend */
WITH fo AS (
  SELECT * FROM orders
  WHERE order_date BETWEEN toDate('${start}') AND toDate('${end}')
  ${audience==='members' ? 'AND is_member_snapshot = 1' : audience==='non_members' ? 'AND is_member_snapshot = 0' : ''}
)
SELECT customer_id, sum(total) AS total_spend, countDistinct(id) AS orders
FROM fo
GROUP BY customer_id
ORDER BY total_spend DESC
LIMIT ${N};`,
      all_customers: ({start, end}) => `/* All customers who purchased in range */
SELECT distinct customer_id
FROM orders
WHERE order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      members: ({start,end}) => `SELECT distinct customer_id FROM orders WHERE is_member_snapshot=1 AND order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      non_members: ({start,end}) => `SELECT distinct customer_id FROM orders WHERE is_member_snapshot=0 AND order_date BETWEEN toDate('${start}') AND toDate('${end}');`,
      revenue_analysis: ({start,end}) => `/* Revenue analysis by month */
SELECT formatDateTime(order_date, '%Y-%m') AS month, 
       sum(total) AS revenue,
       countDistinct(customer_id) AS customers
FROM orders
WHERE order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY month
ORDER BY month;`,
      product_performance: ({start,end,N}) => `/* Top products by revenue */
SELECT oi.item_name, 
       sum(oi.line_total) AS revenue,
       sum(oi.qty) AS units_sold
FROM order_items oi 
INNER JOIN orders o ON o.id=oi.order_id
WHERE oi.item_type='product' AND o.order_date BETWEEN toDate('${start}') AND toDate('${end}')
GROUP BY oi.item_name
ORDER BY revenue DESC
LIMIT ${N};`
    };

    const TITLES = {
      top_spenders: 'Top spending customers',
      all_customers: 'All customers (within date range)',
      members: 'Members only',
      non_members: 'Non‑Members only',
      revenue_analysis: 'Revenue Analysis by Month',
      product_performance: 'Product Performance'
    };

    // --- Renderers -------------------------------------------------------------
    function renderSQL(key) {
      const audience = $('#audience').value;
      const N = +$('#limitN').value;
      const start = $('#dateStart').value;
      const end = $('#dateEnd').value;
      const fn = SQLS[key];
      const sql = fn ? fn({audience, N, start, end}) : '-- no template';
      $('#active-report-title').textContent = TITLES[key] || 'Report';
      $('#sqlBox').textContent = sql;
      window.lastSQL = sql;
      window.lastReportKey = key;
    }

    // Bind report clicks
    $$('.rep-btn').forEach(btn => {
      if (btn.dataset.report) {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          renderSQL(btn.dataset.report);
        });
      }
    });
    
    $('#applyFilters').addEventListener('click', () => { 
      if (window.lastReportKey) renderSQL(window.lastReportKey); 
    });
    
    $('#copySql').addEventListener('click', async () => {
      await navigator.clipboard.writeText($('#sqlBox').textContent);
      alert('SQL copied');
    });
    
    $('#runSql').addEventListener('click', async () => {
      // Submit the SQL form
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '<?php echo e(route("reports.run")); ?>';
      form.innerHTML = `
        <?php echo csrf_field(); ?>
        <input type="hidden" name="sql" value="${$('#sqlBox').textContent}">
      `;
      document.body.appendChild(form);
      form.submit();
    });

    // Search filter for sidebar
    $('#report-search').addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      $$('.rep-btn').forEach(b => {
        const show = b.textContent.toLowerCase().includes(q);
        b.parentElement.style.display = show ? '' : 'none';
      });
    });

    // Chips in chat
    $$('.chip').forEach(c => c.addEventListener('click', () => { 
      $('#chatInput').value = c.textContent; 
    }));

    // Chat -> NL to report key
    function nlToReportKey(text) {
      const t = text.toLowerCase();
      if (t.includes('spender') || (t.includes('top') && t.includes('customer'))) return 'top_spenders';
      if (t.includes('revenue') && t.includes('analysis')) return 'revenue_analysis';
      if (t.includes('product') && (t.includes('performance') || t.includes('top'))) return 'product_performance';
      if (t.includes('member') && t.includes('only')) return 'members';
      if (t.includes('non') && t.includes('member')) return 'non_members';
      return 'top_spenders';
    }

    function pushChat(role, text) {
      const row = document.createElement('div');
      row.className = 'flex items-start gap-2';
      if (role==='user') {
        row.innerHTML = '<div class="w-7 h-7 rounded-full bg-slate-900/10 grid place-items-center shrink-0"><i data-lucide="user" class="w-4 h-4 text-slate-700"></i></div><div class="bg-white rounded-2xl p-3 text-sm ring-1 ring-slate-200">'+text+'</div>';
      } else {
        row.innerHTML = '<div class="w-7 h-7 rounded-full bg-brand-600/10 grid place-items-center shrink-0"><i data-lucide="bot" class="w-4 h-4 text-brand-700"></i></div><div class="bg-slate-50 rounded-2xl p-3 text-sm shadow-inner">'+text+'</div>';
      }
      $('#chat').appendChild(row);
      $('#chat').scrollTop = $('#chat').scrollHeight;
      lucide.createIcons();
    }

    // Handle chat form submission
    $('#chatForm').addEventListener('submit', (e) => {
      const text = $('#chatInput').value.trim();
      if (!text) {
        e.preventDefault();
        alert('Please enter a question for the AI.');
        return;
      }
      
      // Show user message in chat
      pushChat('user', text);
      
      // Let the form submit naturally to the backend
      // The backend will handle the AI processing and redirect back
      // Don't prevent default - let Laravel handle the form submission
    });
  </script>
</body>
</html><?php /**PATH C:\Users\Dell\Desktop\php-projects\Bizzflo\ai-reporting\resources\views/reports/index.blade.php ENDPATH**/ ?>