{
  "title": "Classes & Trainings",
  "description": "Class enrollment, popularity, and training program analytics",
  "layout": "grid",
  "widgets": [
    {
      "id": "classes_summary",
      "title": "Classes Overview",
      "type": "metric",
      "sql": "SELECT COUNT(DISTINCT iid.item_name) as total_classes, SUM(iid.quantity) as total_seats_sold, COUNT(DISTINCT id.id) as total_bookings, SUM(iid.total_price) as total_revenue FROM invoice_details id INNER JOIN invoice_items_detail iid ON id.id = iid.invoice_id WHERE iid.item_type = 'class'",
      "config": {
        "metrics": [
          {"label": "Total Classes", "field": "total_classes", "format": "number"},
          {"label": "Seats Sold", "field": "total_seats_sold", "format": "number"},
          {"label": "Total Bookings", "field": "total_bookings", "format": "number"},
          {"label": "Total Revenue", "field": "total_revenue", "format": "currency"}
        ]
      }
    },
    {
      "id": "popular_classes",
      "title": "Most Popular Classes",
      "type": "bar",
      "sql": "SELECT iid.item_name as class_name, SUM(iid.quantity) as seats_sold, COUNT(DISTINCT id.id) as booking_count FROM invoice_details id INNER JOIN invoice_items_detail iid ON id.id = iid.invoice_id WHERE iid.item_type = 'class' GROUP BY class_name ORDER BY seats_sold DESC LIMIT 15",
      "config": {
        "xAxis": "class_name",
        "yAxis": "seats_sold"
      }
    },
    {
      "id": "class_enrollment_trend",
      "title": "Class Enrollment Trend",
      "type": "line",
      "sql": "SELECT formatDateTime(toStartOfMonth(id.invoice_date), '%Y-%m') as month, SUM(iid.quantity) as seats_sold, COUNT(DISTINCT id.id) as bookings FROM invoice_details id INNER JOIN invoice_items_detail iid ON id.id = iid.invoice_id WHERE iid.item_type = 'class' GROUP BY month ORDER BY month DESC LIMIT 12",
      "config": {
        "xAxis": "month",
        "yAxis": "seats_sold",
        "secondaryAxis": "bookings"
      }
    },
    {
      "id": "classes_new_customers",
      "title": "Classes Bringing New Customers",
      "type": "table",
      "sql": "WITH first_dt AS (SELECT customer_id, min(invoice_date) AS first_date FROM invoice_details GROUP BY customer_id) SELECT iid.item_name AS class_name, COUNT(*) AS new_customers FROM first_dt ft INNER JOIN invoice_details id ON id.customer_id = ft.customer_id AND id.invoice_date = ft.first_date INNER JOIN invoice_items_detail iid ON iid.invoice_id = id.id WHERE iid.item_type = 'class' GROUP BY class_name ORDER BY new_customers DESC LIMIT 20",
      "config": {
        "columns": ["class_name", "new_customers"]
      }
    },
    {
      "id": "top_class_spenders",
      "title": "Top Class Spenders",
      "type": "table",
      "sql": "SELECT id.customer_name, SUM(iid.total_price) AS class_spend, COUNT(DISTINCT id.id) AS booking_count, SUM(iid.quantity) as total_seats FROM invoice_details id INNER JOIN invoice_items_detail iid ON id.id = iid.invoice_id WHERE iid.item_type = 'class' GROUP BY id.customer_name ORDER BY class_spend DESC LIMIT 50",
      "config": {
        "columns": ["customer_name", "class_spend", "booking_count", "total_seats"]
      }
    },
    {
      "id": "class_revenue_by_type",
      "title": "Revenue by Class Type",
      "type": "pie",
      "sql": "SELECT iid.category, SUM(iid.total_price) as revenue, SUM(iid.quantity) as seats FROM invoice_details id INNER JOIN invoice_items_detail iid ON id.id = iid.invoice_id WHERE iid.item_type = 'class' GROUP BY iid.category ORDER BY revenue DESC",
      "config": {
        "labelField": "category",
        "valueField": "revenue"
      }
    },{
      "id": "Best-selling classes (YTD / This Month)",
      "title": "Best-selling classes (YTD / This Month)",
      "type": "table",
      "sql": " SELECT     iid.item_name,    iid.category,    COUNT(DISTINCT id.id) AS transaction_count,    SUM(iid.quantity) AS quantity_sold,    SUM(iid.total_price) AS total_sales,    SUMIf(iid.total_price, toYear(id.created_at) = toYear(today())) AS ytd_sales,    SUMIf(iid.total_price, toStartOfMonth(id.created_at) = toStartOfMonth(today())) AS this_month_sales FROM invoice_details id INNER JOIN invoice_items_detail iid     ON id.id = iid.invoice_id WHERE     id.status = '1'    AND iid.item_type = 'class'GROUP BY     iid.item_name,     iid.category ORDER BY     ytd_sales DESC   LIMIT 50;",
      "config": {
        "columns": ["item_name", "category", "transaction_count", "quantity_sold", "total_sales", "ytd_sales", "this_month_sales"]
      }
    },{
      "id": "Highest revenue classes",
      "title": "Highest revenue classes",
      "type": "table",
      "sql": " SELECT     iid.item_name,    iid.category,    COUNT(DISTINCT id.id) AS transaction_count,    SUM(iid.quantity) AS quantity_sold,    SUM(iid.total_price) AS total_sales,    SUMIf(iid.total_price, toYear(id.created_at) = toYear(today())) AS ytd_sales,    SUMIf(iid.total_price, toStartOfMonth(id.created_at) = toStartOfMonth(today())) AS this_month_sales FROM invoice_details id INNER JOIN invoice_items_detail iid     ON id.id = iid.invoice_id WHERE     id.status = '1'    AND iid.item_type = 'class'GROUP BY     iid.item_name,     iid.category ORDER BY     ytd_sales DESC   LIMIT 50; ",
      "config": {
        "columns": ["item_name", "category", "transaction_count", "quantity_sold", "total_sales", "ytd_sales", "this_month_sales"]
      }
    },{
      "id": "Highest margin classes",
      "title": "Highest margin classes",
      "type": "table",
      "sql": "SELECT    cs.class_id,    cs.class_name,       COUNT(DISTINCT cs.enrollment_id) AS otal_enrollments,      SUM(iid.total_price) AS total_revenue,    SUM(iid.COGS) AS total_cogs,    SUM(iid.total_price - iid.COGS) AS total_profit,       CASE         WHEN SUM(iid.total_price) = 0 THEN 0        ELSE (SUM(iid.total_price - iid.COGS) / SUM(iid.total_price)) * 100    END AS profit_margin_percent FROM class_sessions cs INNER JOIN invoice_items_detail iid    ON iid.invoice_id = cs.invoice_id    AND iid.item_type = 'class'    AND iid.item_id = cs.class_id INNER JOIN invoice_details id    ON id.id = cs.invoice_id    AND id.status = '1' GROUP BY    cs.class_id,    cs.class_name ORDER BY    total_profit DESC LIMIT 25;",
      "config": {
        "columns": [ "class_name", "otal_enrollments", "total_revenue", "total_cogs", "total_profit", "profit_margin_percent"]
      }
    },{
      "id": "Class fill rate",
      "title": "Class fill rate",
      "type": "table",
      "sql": "SELECT    cs.class_id,    cs.class_name,    cs.class_capacity,    SUM(cs.enrollment_quantity) AS total_booked,    CASE        WHEN cs.class_capacity = 0 THEN 0        ELSE (SUM(cs.enrollment_quantity) / cs.class_capacity) * 100    END AS fill_rate_percent FROM class_sessions cs WHERE cs.is_parent_session = 1    GROUP BY    cs.class_id,    cs.class_name,    cs.class_capacity ORDER BY fill_rate_percent DESC;",
      "config": {
        "columns": [ "class_name", "class_capacity", "total_booked", "fill_rate_percent"]
      }
    },{
      "id": "Revenue generated per instructor",
      "title": "Revenue generated per instructor",
      "type": "table",
      "sql": "SELECT    cs.resource_id AS instructor_id,    cs.resource_name AS instructor_name,    COUNT(DISTINCT cs.class_id) AS total_classes_taught,    COUNT(DISTINCT cs.session_id) AS total_sessions_taught,    SUM(iid.total_price) AS total_revenue_generated FROM class_sessions cs left outer JOIN invoice_items_detail iid    ON iid.invoice_id = cs.invoice_id    AND iid.item_type = 'class'    AND iid.item_id = cs.class_id left outer JOIN invoice_details id     ON id.id = cs.invoice_id    AND id.status ='1'  GROUP BY    cs.resource_id,    cs.resource_name ORDER BY    total_revenue_generated DESC;",
      "config": {
        "columns": ["instructor_name", "total_classes_taught", "total_sessions_taught", "total_revenue_generated"]
      }
    },{
      "id": "Average attendance per class",
      "title": "Average attendance per class",
      "type": "table",
      "sql": "SELECT    cs.class_id,    cs.class_name,    COUNT(*) AS total_sessions,    COUNTIf(cs.is_checked_in = 1) AS total_attendance,    (total_attendance / total_sessions) AS avg_attendance_per_session FROM class_sessions cs GROUP BY    cs.class_id,    cs.class_name ORDER BY avg_attendance_per_session DESC;",
      "config": {
        "columns": [ "class_name", "total_sessions", "total_attendance", "avg_attendance_per_session"]
      }
    },{
      "id": "Class capacity utilization per session",
      "title": "Class capacity utilization per session",
      "type": "table",
      "sql": "SELECT    session_id,session_name,    class_id,    class_name,    class_capacity,    COUNTIf(is_checked_in = 1) AS attendance,    (attendance / class_capacity) * 100 AS capacity_utilization_percent FROM class_sessions GROUP BY    session_id, session_name,   class_id,    class_name,    class_capacity ORDER BY capacity_utilization_percent DESC;",
      "config": {
        "columns": [ "session_name","class_name", "class_capacity", "attendance", "capacity_utilization_percent"]
      }
    },{
      "id": "Repeat student rate per class",
      "title": "Repeat student rate per class",
      "type": "table",
      "sql": "SELECT    class_id,    class_name,    COUNT(*) AS total_unique_customers,    COUNTIf(session_count > 1) AS repeat_customers,    (repeat_customers / total_unique_customers) * 100 AS repeat_student_rate_percent FROM(    SELECT        class_id,        class_name,        customer_id,        COUNTIf(is_checked_in = 1) AS session_count    FROM class_sessions  GROUP BY        class_id,        class_name,        customer_id)GROUP BY    class_id,    class_name ORDER BY repeat_student_rate_percent DESC;",
      "config": {
        "columns": [ "class_name", "total_unique_customers", "repeat_customers", "repeat_student_rate_percent"]
      }
    }
  ]
}

